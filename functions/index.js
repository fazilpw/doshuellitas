// functions/index.js
// ‚ö° CLOUD FUNCTIONS PARA CLUB CANINO DOS HUELLITAS

const { setGlobalOptions } = require("firebase-functions");
const { onRequest } = require("firebase-functions/v2/https");
const { onDocumentCreated, onDocumentUpdated } = require("firebase-functions/v2/firestore");
const { logger } = require("firebase-functions");
const admin = require("firebase-admin");

// Inicializar Firebase Admin
admin.initializeApp();

// Configuraci√≥n global
setGlobalOptions({ 
  maxInstances: 10,
  region: "southamerica-east1" // Cercano a Colombia
});

// ============================================
// üå± FUNCI√ìN: CREAR DATOS DE PRUEBA
// ============================================
exports.seedTestData = onRequest({ cors: true }, async (req, res) => {
  try {
    logger.info("üå± Creando datos de prueba para Club Canino...");
    
    const db = admin.firestore();
    
    // üë• Usuarios de prueba
    const testUsers = [
      {
        id: 'padre-test-001',
        email: 'maria@test.com',
        role: 'padre',
        fullName: 'Mar√≠a Garc√≠a Test',
        phone: '3007654321',
        clubMemberSince: new Date(),
        createdAt: new Date()
      },
      {
        id: 'profesor-test-001',
        email: 'profesor@test.com', 
        role: 'profesor',
        fullName: 'Carlos Profesor Test',
        phone: '3001234567',
        clubMemberSince: new Date(),
        createdAt: new Date()
      },
      {
        id: 'admin-test-001',
        email: 'admin@test.com',
        role: 'admin', 
        fullName: 'Juan Pablo Admin Test',
        phone: '3144329824',
        clubMemberSince: new Date(),
        createdAt: new Date()
      }
    ];
    
    // Crear usuarios
    for (const user of testUsers) {
      await db.doc(`users/${user.id}`).set(user);
      logger.info(`‚úÖ Usuario creado: ${user.email}`);
      
      // üêï Crear perros solo para padres
      if (user.role === 'padre') {
        const testDogs = [
          {
            name: 'Max Test',
            breed: 'Golden Retriever',
            size: 'grande',
            age: 3,
            weight: 25.5,
            color: 'dorado',
            active: true,
            createdAt: new Date()
          },
          {
            name: 'Luna Test',
            breed: 'Beagle', 
            size: 'mediano',
            age: 2,
            weight: 12.3,
            color: 'tricolor',
            active: true,
            createdAt: new Date()
          }
        ];
        
        for (let i = 0; i < testDogs.length; i++) {
          const dogId = `dog-test-${user.id}-${i + 1}`;
          await db.doc(`users/${user.id}/dogs/${dogId}`).set(testDogs[i]);
          
          // üìä Crear evaluaciones de ejemplo
          const evaluations = [
            {
              date: new Date().toISOString().split('T')[0],
              location: 'casa',
              evaluatorId: user.id,
              evaluatorName: user.fullName,
              metrics: {
                energy: 7,
                sociability: 8,
                obedience: 6,
                anxiety: 4
              },
              behaviors: {
                barksMuch: 'normal',
                begsFood: 'a_veces',
                destructive: 'nunca',
                socialWithDogs: 'mucho'
              },
              notes: 'Comportamiento excelente en casa',
              highlights: 'Muy sociable con otros perros',
              concerns: 'Un poco ansioso durante tormentas',
              createdAt: new Date()
            },
            {
              date: new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0], // Ayer
              location: 'colegio',
              evaluatorId: 'profesor-test-001',
              evaluatorName: 'Carlos Profesor Test',
              metrics: {
                energy: 8,
                sociability: 9,
                obedience: 7,
                anxiety: 3
              },
              behaviors: {
                barksMuch: 'poco',
                begsFood: 'nunca',
                destructive: 'nunca',
                socialWithDogs: 'mucho'
              },
              notes: 'Excelente d√≠a en el colegio',
              highlights: 'L√≠der natural en actividades grupales',
              concerns: 'Ninguna preocupaci√≥n',
              createdAt: new Date(Date.now() - 24*60*60*1000)
            }
          ];
          
          for (let j = 0; j < evaluations.length; j++) {
            const evalId = `eval-${dogId}-${j + 1}`;
            await db.doc(`users/${user.id}/dogs/${dogId}/evaluations/${evalId}`).set(evaluations[j]);
          }
          
          logger.info(`‚úÖ Perro creado: ${testDogs[i].name} con ${evaluations.length} evaluaciones`);
        }
      }
    }
    
    // üìã Templates de notificaciones
    const notificationTemplates = [
      {
        key: 'routine_reminder',
        category: 'routine',
        title: 'Hora de {routineName} para {dogName}',
        body: 'No olvides {action} de {dogName}',
        priority: 'medium',
        variables: ['dogName', 'routineName', 'action']
      },
      {
        key: 'evaluation_complete',
        category: 'behavior',
        title: 'Nueva evaluaci√≥n de {dogName}',
        body: '{evaluatorName} evalu√≥ a {dogName} en {location}',
        priority: 'medium',
        variables: ['dogName', 'evaluatorName', 'location']
      },
      {
        key: 'behavior_alert',
        category: 'behavior',
        title: 'Alerta de comportamiento: {dogName}',
        body: '{dogName} mostr√≥ {behavior}. Recomendaci√≥n: {suggestion}',
        priority: 'high',
        variables: ['dogName', 'behavior', 'suggestion']
      }
    ];
    
    for (const template of notificationTemplates) {
      await db.doc(`notificationTemplates/${template.key}`).set({
        ...template,
        createdAt: new Date()
      });
    }
    
    logger.info("üéâ Datos de prueba creados exitosamente");
    
    res.status(200).json({
      success: true,
      message: 'Datos de prueba creados exitosamente',
      created: {
        users: testUsers.length,
        dogs: testUsers.filter(u => u.role === 'padre').length * 2,
        evaluations: testUsers.filter(u => u.role === 'padre').length * 2 * 2,
        templates: notificationTemplates.length
      }
    });
    
  } catch (error) {
    logger.error("‚ùå Error creando datos de prueba:", error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ============================================
// üìä FUNCI√ìN: PROCESAR NUEVA EVALUACI√ìN
// ============================================
exports.processNewEvaluation = onDocumentCreated(
  "users/{userId}/dogs/{dogId}/evaluations/{evalId}",
  async (event) => {
    try {
      const { userId, dogId, evalId } = event.params;
      const evaluationData = event.data.data();
      
      logger.info(`üìä Procesando nueva evaluaci√≥n: ${evalId} para perro ${dogId}`);
      
      const db = admin.firestore();
      
      // Obtener informaci√≥n del perro y due√±o
      const [dogDoc, userDoc] = await Promise.all([
        db.doc(`users/${userId}/dogs/${dogId}`).get(),
        db.doc(`users/${userId}`).get()
      ]);
      
      if (!dogDoc.exists || !userDoc.exists) {
        logger.error("‚ùå Perro o usuario no encontrado");
        return;
      }
      
      const dogData = dogDoc.data();
      const userData = userDoc.data();
      
      // üìà Actualizar estad√≠sticas del perro
      await updateDogStatistics(userId, dogId, dogData.name);
      
      // üîî Crear notificaci√≥n para el due√±o
      await createNotification(userId, {
        title: `Nueva evaluaci√≥n de ${dogData.name}`,
        message: `${evaluationData.evaluatorName} evalu√≥ a ${dogData.name} en ${evaluationData.location}`,
        type: 'info',
        category: 'behavior',
        dogId: dogId,
        dogName: dogData.name,
        priority: 'medium',
        data: {
          evalId: evalId,
          location: evaluationData.location,
          evaluatorName: evaluationData.evaluatorName
        }
      });
      
      // üö® Detectar alertas de comportamiento
      await checkBehaviorAlerts(userId, dogId, dogData, evaluationData);
      
      logger.info(`‚úÖ Evaluaci√≥n procesada exitosamente: ${evalId}`);
      
    } catch (error) {
      logger.error("‚ùå Error procesando evaluaci√≥n:", error);
    }
  }
);

// ============================================
// üîî FUNCI√ìN: CREAR NOTIFICACI√ìN
// ============================================
async function createNotification(userId, notificationData) {
  try {
    const db = admin.firestore();
    
    await db.collection(`users/${userId}/notifications`).add({
      ...notificationData,
      read: false,
      createdAt: new Date(),
      sentAt: new Date()
    });
    
    logger.info(`üîî Notificaci√≥n creada para usuario: ${userId}`);
    
  } catch (error) {
    logger.error("‚ùå Error creando notificaci√≥n:", error);
  }
}

// ============================================
// üìà FUNCI√ìN: ACTUALIZAR ESTAD√çSTICAS DEL PERRO
// ============================================
async function updateDogStatistics(userId, dogId, dogName) {
  try {
    const db = admin.firestore();
    
    // Obtener todas las evaluaciones del perro
    const evaluationsSnapshot = await db
      .collection(`users/${userId}/dogs/${dogId}/evaluations`)
      .orderBy('createdAt', 'desc')
      .get();
    
    const evaluations = evaluationsSnapshot.docs.map(doc => doc.data());
    
    if (evaluations.length === 0) return;
    
    // Calcular estad√≠sticas
    const stats = calculateDogStats(evaluations);
    
    // Guardar en evaluationSummaries
    await db.doc(`evaluationSummaries/${dogId}`).set({
      dogId,
      dogName,
      ownerId: userId,
      stats,
      lastEvaluation: {
        date: evaluations[0].date,
        location: evaluations[0].location,
        evaluatorName: evaluations[0].evaluatorName
      },
      lastUpdated: new Date()
    }, { merge: true });
    
    logger.info(`üìà Estad√≠sticas actualizadas para perro: ${dogId}`);
    
  } catch (error) {
    logger.error("‚ùå Error actualizando estad√≠sticas:", error);
  }
}

// ============================================
// üßÆ FUNCI√ìN: CALCULAR ESTAD√çSTICAS
// ============================================
function calculateDogStats(evaluations) {
  const total = evaluations.length;
  const casaEvals = evaluations.filter(e => e.location === 'casa');
  const colegioEvals = evaluations.filter(e => e.location === 'colegio');
  
  const avgMetric = (metric) => {
    const values = evaluations
      .map(e => e.metrics?.[metric])
      .filter(v => v !== undefined && v !== null);
    return values.length > 0 
      ? Math.round((values.reduce((a, b) => a + b, 0) / values.length) * 10) / 10
      : 0;
  };
  
  const avgByLocation = (evals, metric) => {
    const values = evals
      .map(e => e.metrics?.[metric])
      .filter(v => v !== undefined && v !== null);
    return values.length > 0 
      ? Math.round((values.reduce((a, b) => a + b, 0) / values.length) * 10) / 10
      : 0;
  };
  
  return {
    totalEvaluations: total,
    averageEnergy: avgMetric('energy'),
    averageSociability: avgMetric('sociability'),
    averageObedience: avgMetric('obedience'),
    averageAnxiety: avgMetric('anxiety'),
    
    casa: {
      evaluations: casaEvals.length,
      avgEnergy: avgByLocation(casaEvals, 'energy'),
      avgSociability: avgByLocation(casaEvals, 'sociability'),
      avgObedience: avgByLocation(casaEvals, 'obedience'),
      avgAnxiety: avgByLocation(casaEvals, 'anxiety')
    },
    
    colegio: {
      evaluations: colegioEvals.length,
      avgEnergy: avgByLocation(colegioEvals, 'energy'),
      avgSociability: avgByLocation(colegioEvals, 'sociability'),
      avgObedience: avgByLocation(colegioEvals, 'obedience'),
      avgAnxiety: avgByLocation(colegioEvals, 'anxiety')
    }
  };
}

// ============================================
// üö® FUNCI√ìN: DETECTAR ALERTAS DE COMPORTAMIENTO
// ============================================
async function checkBehaviorAlerts(userId, dogId, dogData, evaluationData) {
  try {
    const alerts = [];
    
    // Alerta: Ansiedad alta
    if (evaluationData.metrics?.anxiety >= 8) {
      alerts.push({
        type: 'high_anxiety',
        title: `Alta ansiedad detectada en ${dogData.name}`,
        message: `${dogData.name} mostr√≥ niveles altos de ansiedad (${evaluationData.metrics.anxiety}/10). Considera t√©cnicas de relajaci√≥n.`,
        priority: 'high',
        suggestions: [
          'Ejercicios de respiraci√≥n profunda',
          'M√∫sica relajante para perros',
          'Evitar situaciones estresantes por hoy'
        ]
      });
    }
    
    // Alerta: Energ√≠a muy alta en casa
    if (evaluationData.location === 'casa' && evaluationData.metrics?.energy >= 9) {
      alerts.push({
        type: 'high_energy_home',
        title: `${dogData.name} con mucha energ√≠a en casa`,
        message: `Considera aumentar el tiempo de ejercicio para ${dogData.name}.`,
        priority: 'medium',
        suggestions: [
          'Paseo extra de 20 minutos',
          'Juegos de buscar en el parque',
          'Actividades mentales estimulantes'
        ]
      });
    }
    
    // Alerta: Comportamiento destructivo
    if (evaluationData.behaviors?.destructive === 'frecuente') {
      alerts.push({
        type: 'destructive_behavior',
        title: `Comportamiento destructivo en ${dogData.name}`,
        message: `${dogData.name} mostr√≥ comportamiento destructivo frecuente.`,
        priority: 'high',
        suggestions: [
          'Aumentar tiempo de ejercicio',
          'Proporcionar juguetes apropiados',
          'Considerar entrenamiento especializado'
        ]
      });
    }
    
    // Crear notificaciones para cada alerta
    for (const alert of alerts) {
      await createNotification(userId, {
        title: alert.title,
        message: alert.message,
        type: 'warning',
        category: 'alert',
        dogId: dogId,
        dogName: dogData.name,
        priority: alert.priority,
        data: {
          alertType: alert.type,
          suggestions: alert.suggestions,
          evaluationLocation: evaluationData.location
        }
      });
    }
    
    if (alerts.length > 0) {
      logger.info(`üö® ${alerts.length} alertas creadas para perro: ${dogId}`);
    }
    
  } catch (error) {
    logger.error("‚ùå Error detectando alertas:", error);
  }
}

// ============================================
// üßπ FUNCI√ìN: LIMPIAR DATOS DE PRUEBA
// ============================================
exports.cleanTestData = onRequest({ cors: true }, async (req, res) => {
  try {
    logger.info("üßπ Limpiando datos de prueba...");
    
    const db = admin.firestore();
    
    // IDs de usuarios de prueba
    const testUserIds = ['padre-test-001', 'profesor-test-001', 'admin-test-001'];
    
    for (const userId of testUserIds) {
      // Eliminar usuario y todas sus sub-colecciones
      await deleteUserData(db, userId);
    }
    
    // Limpiar templates
    const templatesSnapshot = await db.collection('notificationTemplates').get();
    const deletePromises = templatesSnapshot.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);
    
    // Limpiar summaries
    const summariesSnapshot = await db.collection('evaluationSummaries').get();
    const deleteSummaryPromises = summariesSnapshot.docs.map(doc => doc.ref.delete());
    await Promise.all(deleteSummaryPromises);
    
    logger.info("‚úÖ Datos de prueba limpiados");
    
    res.status(200).json({
      success: true,
      message: 'Datos de prueba limpiados exitosamente'
    });
    
  } catch (error) {
    logger.error("‚ùå Error limpiando datos:", error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ============================================
// üóëÔ∏è FUNCI√ìN AUXILIAR: ELIMINAR DATOS DE USUARIO
// ============================================
async function deleteUserData(db, userId) {
  try {
    // Obtener perros del usuario
    const dogsSnapshot = await db.collection(`users/${userId}/dogs`).get();
    
    for (const dogDoc of dogsSnapshot.docs) {
      const dogId = dogDoc.id;
      
      // Eliminar evaluaciones del perro
      const evaluationsSnapshot = await db.collection(`users/${userId}/dogs/${dogId}/evaluations`).get();
      const evalDeletePromises = evaluationsSnapshot.docs.map(doc => doc.ref.delete());
      await Promise.all(evalDeletePromises);
      
      // Eliminar perro
      await dogDoc.ref.delete();
    }
    
    // Eliminar notificaciones del usuario
    const notificationsSnapshot = await db.collection(`users/${userId}/notifications`).get();
    const notifDeletePromises = notificationsSnapshot.docs.map(doc => doc.ref.delete());
    await Promise.all(notifDeletePromises);
    
    // Eliminar usuario
    await db.doc(`users/${userId}`).delete();
    
    logger.info(`üóëÔ∏è Datos eliminados para usuario: ${userId}`);
    
  } catch (error) {
    logger.error(`‚ùå Error eliminando datos de usuario ${userId}:`, error);
  }
}