// src/components/dashboard/QuickEvaluationForm.jsx
// üîî VERSI√ìN CON NOTIFICACIONES AUTOM√ÅTICAS INTEGRADAS

import { useState } from 'react';
import supabase from '../../lib/supabase.js';
import { NotificationHelper } from '../../utils/notificationHelper.js'; // ‚úÖ NUEVO IMPORT

const QuickEvaluationForm = ({ dog, userId, onClose, onSave }) => {
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    energy_level: 5,
    sociability_level: 5,
    obedience_level: 5,
    anxiety_level: 5,
    notes: '',
    highlights: '',
    concerns: ''
  });

  const handleSliderChange = (field, value) => {
    setFormData(prev => ({
      ...prev,
      [field]: parseInt(value)
    }));
  };

  const handleTextChange = (field, value) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      console.log('üìù Guardando evaluaci√≥n r√°pida para:', dog.name);
      
      const today = new Date().toISOString().split('T')[0];
      
      const evaluationData = {
        dog_id: dog.id,
        evaluator_id: userId,
        location: 'colegio', // Siempre colegio para profesores
        date: today,
        ...formData
      };

      console.log('üì§ Datos de evaluaci√≥n r√°pida:', evaluationData);

      // üíæ Guardar evaluaci√≥n en Supabase
      const { data, error } = await supabase
        .from('evaluations')
        .insert([evaluationData])
        .select()
        .single();

      if (error) {
        console.error('‚ùå Error guardando evaluaci√≥n:', error);
        alert('‚ùå Error al guardar la evaluaci√≥n. Int√©ntalo de nuevo.');
        return;
      }

      console.log('‚úÖ Evaluaci√≥n r√°pida guardada exitosamente:', data);

      // üîî NUEVO: NOTIFICACIONES AUTOM√ÅTICAS
      try {
        console.log('üîî Procesando notificaciones autom√°ticas...');
        
        if (dog && data) {
          await NotificationHelper.checkBehaviorAlertsAfterEvaluation(
            data,     // evaluaci√≥n reci√©n guardada
            dog,      // datos del perro
            userId    // ID del evaluador
          );
          console.log('‚úÖ Notificaciones autom√°ticas procesadas para evaluaci√≥n r√°pida');
          
          // Mensaje especial para evaluaci√≥n r√°pida
          alert(`‚úÖ Evaluaci√≥n r√°pida de ${dog.name} completada!\nüîî Notificaciones autom√°ticas enviadas a los padres.`);
          
        } else {
          console.warn('‚ö†Ô∏è Datos insuficientes para notificaciones autom√°ticas');
          alert(`‚úÖ Evaluaci√≥n de ${dog.name} guardada (datos incompletos para notificaciones)`);
        }
        
      } catch (notificationError) {
        console.error('‚ùå Error en notificaciones autom√°ticas:', notificationError);
        // No fallar la evaluaci√≥n por errores de notificaci√≥n
        alert(`‚úÖ Evaluaci√≥n de ${dog.name} guardada (notificaciones con problemas t√©cnicos)`);
      }

      // üìû Ejecutar callbacks
      if (onSave) {
        onSave(data);
      }

      // Cerrar formulario despu√©s de un breve delay
      setTimeout(() => {
        if (onClose) onClose();
      }, 1500);

    } catch (error) {
      console.error('‚ùå Error en submit de evaluaci√≥n r√°pida:', error);
      alert('‚ùå Error inesperado. Int√©ntalo de nuevo.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        
        {/* Header */}
        <div className="bg-gradient-to-r from-[#56CCF2] to-[#2C3E50] text-white p-6 rounded-t-xl">
          <div className="flex justify-between items-start">
            <div>
              <h2 className="text-2xl font-bold">‚ö° Evaluaci√≥n R√°pida</h2>
              <p className="text-blue-100 mt-1">
                {dog?.name} ‚Ä¢ Colegio ‚Ä¢ {new Date().toLocaleDateString('es-CO')}
              </p>
              <div className="mt-2 bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-sm inline-block">
                üîî Notificaciones autom√°ticas activadas
              </div>
            </div>
            <button
              onClick={onClose}
              className="text-white hover:text-gray-200 text-2xl font-bold"
              type="button"
            >
              √ó
            </button>
          </div>
        </div>

        <form onSubmit={handleSubmit}>
          <div className="p-6 space-y-6">
            
            {/* M√©tricas r√°pidas */}
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-4">üìä Evaluaci√≥n R√°pida de Hoy</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                {/* Energ√≠a */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ‚ö° Energ√≠a
                  </label>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={formData.energy_level}
                    onChange={(e) => handleSliderChange('energy_level', e.target.value)}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Bajo</span>
                    <span className="font-bold text-[#56CCF2] text-lg">{formData.energy_level}</span>
                    <span>Alto</span>
                  </div>
                </div>

                {/* Sociabilidad */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    üêï Sociabilidad
                  </label>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={formData.sociability_level}
                    onChange={(e) => handleSliderChange('sociability_level', e.target.value)}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>T√≠mido</span>
                    <span className="font-bold text-[#56CCF2] text-lg">{formData.sociability_level}</span>
                    <span>Social</span>
                  </div>
                </div>

                {/* Obediencia */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    üéØ Obediencia
                  </label>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={formData.obedience_level}
                    onChange={(e) => handleSliderChange('obedience_level', e.target.value)}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Rebelde</span>
                    <span className="font-bold text-[#56CCF2] text-lg">{formData.obedience_level}</span>
                    <span>Obediente</span>
                  </div>
                </div>

                {/* Ansiedad */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    üò∞ Ansiedad
                  </label>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={formData.anxiety_level}
                    onChange={(e) => handleSliderChange('anxiety_level', e.target.value)}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Relajado</span>
                    <span className="font-bold text-[#56CCF2] text-lg">{formData.anxiety_level}</span>
                    <span>Ansioso</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Observaciones r√°pidas */}
            <div className="space-y-4">
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  üìù Notas del d√≠a
                </label>
                <textarea
                  value={formData.notes}
                  onChange={(e) => handleTextChange('notes', e.target.value)}
                  placeholder="¬øC√≥mo se comport√≥ hoy? Observaciones generales..."
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#56CCF2] focus:border-transparent"
                  rows={3}
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ‚≠ê Lo mejor del d√≠a
                  </label>
                  <textarea
                    value={formData.highlights}
                    onChange={(e) => handleTextChange('highlights', e.target.value)}
                    placeholder="¬øQu√© hizo especialmente bien?"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#56CCF2] focus:border-transparent"
                    rows={2}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ‚ö†Ô∏è Aspectos a mejorar
                  </label>
                  <textarea
                    value={formData.concerns}
                    onChange={(e) => handleTextChange('concerns', e.target.value)}
                    placeholder="¬øAlgo que requiere atenci√≥n?"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#56CCF2] focus:border-transparent"
                    rows={2}
                  />
                </div>
              </div>
            </div>

            {/* Preview de notificaciones que se enviar√°n */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 className="font-medium text-blue-900 mb-2">üîî Vista previa de notificaciones autom√°ticas:</h4>
              <div className="text-sm text-blue-800 space-y-1">
                {formData.anxiety_level >= 8 && (
                  <div>‚Ä¢ üö® Alerta de ansiedad alta ‚Üí Se enviar√° recomendaci√≥n de ejercicios de relajaci√≥n</div>
                )}
                {formData.obedience_level <= 3 && (
                  <div>‚Ä¢ üìö Alerta de obediencia baja ‚Üí Se enviar√° sugerencia de comandos de entrenamiento</div>
                )}
                {formData.energy_level >= 9 && (
                  <div>‚Ä¢ ‚ö° Alerta de energ√≠a muy alta ‚Üí Se enviar√° recomendaci√≥n de m√°s ejercicio</div>
                )}
                {formData.obedience_level >= 8 && (
                  <div>‚Ä¢ ‚úÖ Felicitaci√≥n por excelente obediencia ‚Üí Se enviar√° mensaje positivo</div>
                )}
                {formData.sociability_level >= 8 && (
                  <div>‚Ä¢ üêï Felicitaci√≥n por excelente socializaci√≥n ‚Üí Se enviar√° mensaje positivo</div>
                )}
                {formData.anxiety_level < 8 && formData.obedience_level > 3 && formData.energy_level < 9 && formData.obedience_level < 8 && formData.sociability_level < 8 && (
                  <div>‚Ä¢ üìä Resumen general del d√≠a ‚Üí Se enviar√° evaluaci√≥n est√°ndar</div>
                )}
              </div>
            </div>
          </div>

          {/* Footer con botones */}
          <div className="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 flex justify-between">
            <button
              type="button"
              onClick={onClose}
              className="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              Cancelar
            </button>
            
            <button
              type="submit"
              disabled={loading}
              className="px-8 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'üîÑ Guardando...' : '‚ö° Guardar y Notificar'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default QuickEvaluationForm;