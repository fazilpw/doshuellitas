---
// src/pages/test-supabase.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="Prueba Supabase">
  <div style="padding: 20px; font-family: monospace; max-width: 800px; margin: 0 auto;">
    <h1>ğŸ§ª Prueba de ConexiÃ³n Supabase</h1>
    <div id="results">ğŸ”„ Iniciando prueba...</div>
    
    <div style="margin-top: 20px;">
      <h2>ğŸ” DiagnÃ³stico:</h2>
      <div id="diagnostics"></div>
    </div>
    
    <div style="margin-top: 20px;">
      <h2>ğŸ“Š Datos de Prueba:</h2>
      <div id="data"></div>
    </div>
  </div>

  <script>
    // FunciÃ³n para actualizar resultados de forma segura
    function updateResults(message: string, type: 'info' | 'success' | 'error' = 'info') {
      const resultsDiv = document.getElementById('results');
      if (resultsDiv) {
        const emoji = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'ğŸ”„';
        const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
        resultsDiv.innerHTML = `<span style="color: ${color}">${emoji} ${message}</span>`;
      }
    }

    function updateDiagnostics(message: string) {
      const diagnosticsDiv = document.getElementById('diagnostics');
      if (diagnosticsDiv) {
        diagnosticsDiv.innerHTML += `<p>${message}</p>`;
      }
    }

    function updateData(data: any) {
      const dataDiv = document.getElementById('data');
      if (dataDiv) {
        dataDiv.innerHTML = `<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
      }
    }

    async function testSupabase() {
      updateResults('Iniciando prueba de conexiÃ³n...', 'info');
      updateDiagnostics('ğŸ” Verificando configuraciÃ³n...');
      
      try {
        // Verificar variables de entorno
        const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
        const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
        
        updateDiagnostics(`ğŸ“ URL: ${supabaseUrl ? 'âœ… Configurada' : 'âŒ No configurada'}`);
        updateDiagnostics(`ğŸ”‘ Key: ${supabaseKey ? 'âœ… Configurada' : 'âŒ No configurada'}`);
        
        if (!supabaseUrl || !supabaseKey) {
          throw new Error('Variables de entorno de Supabase no configuradas');
        }

        // Importar Supabase dinÃ¡micamente
        updateDiagnostics('ğŸ“¦ Importando Supabase...');
        const { createClient } = await import('@supabase/supabase-js');
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        updateDiagnostics('ğŸ”— Cliente Supabase creado correctamente');
        updateResults('Conectando a Supabase...', 'info');

        // Probar conexiÃ³n bÃ¡sica
        updateDiagnostics('ğŸ§ª Probando consulta a tabla users...');
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('*')
          .limit(5);

        if (usersError) {
          updateDiagnostics(`âš ï¸ Error en users: ${usersError.message}`);
          
          // Intentar con una tabla que sabemos que existe
          updateDiagnostics('ğŸ§ª Probando conexiÃ³n bÃ¡sica...');
          const { data: testData, error: testError } = await supabase
            .from('users')
            .select('count(*)')
            .limit(1);
            
          if (testError) {
            throw new Error(`Error de conexiÃ³n: ${testError.message}`);
          }
          
          updateResults('ConexiÃ³n establecida pero tabla users tiene problemas', 'success');
          updateData({ 
            connection: 'OK', 
            users_error: usersError.message,
            test_query: testData 
          });
        } else {
          updateDiagnostics(`ğŸ‘¥ Usuarios encontrados: ${users?.length || 0}`);
          updateResults(`Â¡ConexiÃ³n exitosa! ${users?.length || 0} usuarios encontrados`, 'success');
          updateData({ 
            connection: 'OK', 
            users_count: users?.length || 0, 
            users: users 
          });
        }

        // Probar tabla de perros si existe
        updateDiagnostics('ğŸ• Probando tabla dogs...');
        const { data: dogs, error: dogsError } = await supabase
          .from('dogs')
          .select('*')
          .limit(5);

        if (!dogsError && dogs) {
          updateDiagnostics(`ğŸ• Perros encontrados: ${dogs.length}`);
        } else {
          updateDiagnostics(`âš ï¸ Error en dogs: ${dogsError?.message || 'Tabla no existe'}`);
        }

        // Probar tabla de evaluaciones si existe
        updateDiagnostics('ğŸ“Š Probando tabla evaluations...');
        const { data: evaluations, error: evalError } = await supabase
          .from('evaluations')
          .select('*')
          .limit(5);

        if (!evalError && evaluations) {
          updateDiagnostics(`ğŸ“Š Evaluaciones encontradas: ${evaluations.length}`);
        } else {
          updateDiagnostics(`âš ï¸ Error en evaluations: ${evalError?.message || 'Tabla no existe'}`);
        }

        updateDiagnostics('âœ… Prueba completada');

      } catch (error: unknown) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        updateResults(`Error: ${errorMessage}`, 'error');
        updateDiagnostics(`âŒ Error capturado: ${errorMessage}`);
        
        // InformaciÃ³n adicional para debugging
        updateData({
          error: errorMessage,
          env_check: {
            SUPABASE_URL: !!import.meta.env.PUBLIC_SUPABASE_URL,
            SUPABASE_KEY: !!import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
            NODE_ENV: import.meta.env.MODE
          }
        });
      }
    }

    // Ejecutar cuando cargue la pÃ¡gina
    document.addEventListener('DOMContentLoaded', testSupabase);
  </script>
</Layout>